- apiVersion: networking.istio.io/v1
  kind: EnvoyFilter
  metadata:
    name: global-ratelimit
    namespace: online-boutique
  spec:
    workloadSelector:
      labels:
        app: adservice  # 只对 adservice 和 recommendationservice 作用
    configPatches:
      - applyTo: HTTP_FILTER
        match:
          context: SIDECAR_INBOUND
        patch:
          operation: INSERT_BEFORE
          value:
            name: envoy.filters.http.ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
              domain: "ad-recommendation-limit"
              failure_mode_deny: true
              timeout: 2s
              rate_limit_service:
                grpc_service:
                  envoy_grpc:
                    cluster_name: rate_limit_cluster
                  timeout: 0.25s
      - applyTo: VIRTUAL_HOST
        match:
          context: SIDECAR_INBOUND
        patch:
          operation: MERGE
          value:
            rate_limits:
            - actions:
                - request_headers:
                    header_name: "x-request-source"
                    descriptor_key: "recommendationservice"      